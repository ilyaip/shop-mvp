# Функция отправки заказа по email

## Обзор

При оформлении заказа система автоматически отправляет красиво оформленное письмо на email покупателя с деталями заказа.

## Реализация

### API Endpoint

**POST** `/dev-api/send-order-to-email`

**Request Body:**
```json
{
  "address_to": "user@example.com",
  "subject": "Заказ с сайта Cats Toys № ABC123",
  "body_html": "<html>...</html>"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Email sent successfully"
}
```

### Компоненты

#### 1. API Client (`src/shared/api/email.ts`)
Функция для отправки email через бэкенд API:
```typescript
sendOrderEmail(request: SendOrderEmailRequest): Promise<SendOrderEmailResponse>
```

#### 2. Email Template Generator (`src/shared/lib/email-template.ts`)
Генерирует HTML письмо с:
- Красивым дизайном в стиле градиента
- Информацией о заказе (номер, дата)
- Данными покупателя (имя, email, телефон, адрес)
- Списком товаров с изображениями
- Общей суммой заказа
- Брендированным футером

#### 3. Checkout Form (`src/features/checkout-form/model/useCheckoutForm.ts`)
Обновлен для:
- Генерации уникального номера заказа
- Создания HTML письма
- Отправки email через API
- Обработки ошибок (заказ оформляется даже если email не отправлен)

## Формат письма

### Тема письма
```
Заказ с сайта {Название бренда} № {Уникальный номер}
```

Пример: `Заказ с сайта Cats Toys № 1735389123456-ABC123XYZ`

### Содержимое письма

1. **Шапка** - градиентный фон с названием бренда
2. **Номер заказа** - уникальный идентификатор
3. **Информация о доставке**:
   - Имя покупателя
   - Email
   - Телефон
   - Адрес доставки
4. **Состав заказа** - таблица с:
   - Изображением товара
   - Названием
   - Количеством
   - Стоимостью
5. **Итоговая сумма** - выделена крупным шрифтом
6. **Футер** - информация о бренде и год

## Обработка ошибок

### Успешная отправка
- Заказ сохраняется в истории
- Корзина очищается
- Показывается уведомление: "Заказ успешно оформлен!"

### Ошибка отправки email
- Заказ всё равно сохраняется (важно!)
- Корзина очищается
- Показывается предупреждение: "Заказ оформлен, но письмо не отправлено"
- Ошибка логируется в консоль

### Ошибка оформления заказа
- Заказ не сохраняется
- Корзина не очищается
- Показывается ошибка: "Ошибка при оформлении заказа"

## Генерация номера заказа

Формат: `{timestamp}-{random}`

Пример: `1735389123456-ABC123XYZ`

- `timestamp` - текущее время в миллисекундах
- `random` - случайная строка из 9 символов (uppercase)

## Стилизация письма

### Цветовая схема
- Градиент шапки: `#667eea` → `#764ba2`
- Основной текст: `#111827`
- Вторичный текст: `#6b7280`
- Акцентный цвет (итого): `#667eea`
- Фон: `#f9fafb`

### Адаптивность
- Максимальная ширина: 600px
- Оптимизировано для мобильных устройств
- Поддержка темной темы в почтовых клиентах

## Тестирование

### Локальное тестирование

1. Запустите dev сервер:
```bash
npm run dev
```

2. Убедитесь, что бэкенд запущен на `http://localhost:8000`

3. Добавьте товары в корзину

4. Перейдите на страницу оформления заказа

5. Заполните форму с реальным email

6. Нажмите "Оформить заказ"

7. Проверьте почту

### Проверка в консоли

Откройте DevTools → Console для просмотра:
- Запросов к API
- Ошибок отправки email
- Сгенерированного HTML (можно скопировать и открыть в браузере)

## Безопасность

⚠️ **Важно:**
- Email отправляется через бэкенд (не напрямую из браузера)
- Бэкенд должен валидировать email адреса
- Бэкенд должен иметь rate limiting для предотвращения спама
- HTML письма санитизируется на бэкенде

## Будущие улучшения

- [ ] Добавить шаблоны писем для разных типов заказов
- [ ] Поддержка нескольких языков
- [ ] Отправка копии письма администратору
- [ ] Трекинг открытия писем
- [ ] Кастомизация дизайна письма через админ-панель
